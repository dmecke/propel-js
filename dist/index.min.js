"use strict";export var physics;(function(y){let v;(function(t){t[t.CIRCLE=0]="CIRCLE",t[t.RECTANGLE=1]="RECTANGLE"})(v=y.ShapeType||(y.ShapeType={}));function D(t,e){return[...e??t.dynamicBodies,...t.staticBodies,...t.disabledBodies]}y.allBodies=D;function Y(t,e){return[...e??t.dynamicBodies,...t.staticBodies]}y.enabledBodies=Y;function nt(t,e,n){const o=(n??t.dynamicBodies).findIndex(c=>c.id===e.id);o!==-1&&(n??t.dynamicBodies).splice(o,1);const a=t.staticBodies.findIndex(c=>c.id===e.id);a!==-1&&t.staticBodies.splice(a,1),t.disabledBodies.includes(e)||t.disabledBodies.push(e)}y.disableBody=nt;function it(t,e,n){!e.static&&!(n??t.dynamicBodies).find(o=>o.id===e.id)&&(n??t.dynamicBodies).push(e),e.static&&!t.staticBodies.includes(e)&&t.staticBodies.push(e),t.disabledBodies.includes(e)&&t.disabledBodies.splice(t.disabledBodies.indexOf(e),1)}y.enableBody=it;function ot(t,e=!1,n){const o=e?t.staticBodies:D(t,n);if(o.length===0)return{min:x(0,0),max:x(0,0)};const a=o[0];let c=x(a.shapes[0].center.x-a.shapes[0].bounds,a.center.y-a.shapes[0].bounds),i=x(a.shapes[0].center.x+a.shapes[0].bounds,a.center.y+a.shapes[0].bounds);for(const f of o)for(const r of f.shapes)if(r.type===v.CIRCLE)c.x=Math.min(c.x,r.center.x-r.bounds),c.y=Math.min(c.y,r.center.y-r.bounds),i.x=Math.max(i.x,r.center.x+r.bounds),i.y=Math.max(i.y,r.center.y+r.bounds);else if(r.type===v.RECTANGLE)for(const s of r.vertices)c.x=Math.min(c.x,s.x),c.y=Math.min(c.y,s.y),i.x=Math.max(i.x,s.x),i.y=Math.max(i.y,s.y);return{min:c,max:i}}y.getWorldBounds=ot;function at(t,e=1){return{staticBodies:[],dynamicBodies:[],disabledBodies:[],gravity:t??x(0,100),angularDamp:1,damp:1,nextId:1,joints:[],frameCount:0,jointRestriction:1,restTime:e}}y.createWorld=at;function ct(t,e,n,o=1,a=0){t.joints.push({bodyA:e.id,bodyB:n.id,distance:h(g(e.center,n.center))+.5,rigidity:o,elasticity:a})}y.createJoint=ct;function rt(t,e,n,o,a,c,i){const f=K(e,n);return U(t,e,o,a,c,[f],i)}y.createCircle=rt;function st(t,e,n,o,a,c,i,f){const r=Q(e,n,o);return _(t,e,a,c,i,[r],f)}y.createRectangle=st;function _(t,e,n,o,a,c,i){return U(t,e,n,o,a,c,i)}y.createCompoundRectangle=_;function H(t,e){N(t,e,!0)}y.moveBody=H;function N(t,e,n=!1){if(!(!n&&t.static)){t.center=B(t.center,e);for(const o of t.shapes)if(o.center=B(o.center,e),o.type===v.RECTANGLE){for(let a=4;a--;)o.vertices[a]=B(o.vertices[a],e);Z(o)}}}function ut(t,e){const n=g(e,t.center);H(t,n)}y.setCenter=ut;function ft(t,e){const n=e-t.angle;W(t,n)}y.setRotation=ft;function W(t,e){if(e){t.angle+=e,t.static||(t.averageAngle=e);for(const n of t.shapes)if(n.center=k(n.center,t.center,e),n.type===v.RECTANGLE){for(let o=4;o--;)n.vertices[o]=k(n.vertices[o],t.center,e);vt(n),Z(n)}}}y.rotateBody=W;function lt(t,e,n){n=n??e.dynamicBodies;const o=Y(e,n),a=D(e,n),c=[];for(const i of n)!i.velocity&&!i.acceleration||T(e,i)||(i.fixedPosition?(i.velocity.x=0,i.velocity.y=0):(i.velocity=B(i.velocity,l(i.acceleration,1/t)),N(i,l(i.velocity,1/t))),i.fixedRotation?(i.angularVelocity=0,i.angularAcceleration=0):(i.angularVelocity+=i.angularAcceleration*1/t,W(i,i.angularVelocity*1/t)));for(const i of n){const f=e.joints.filter(r=>r.bodyA===i.id||r.bodyB===i.id);for(const r of f){const s=r.bodyA===i.id?r.bodyB:r.bodyA,d=a.find(u=>u.id===s);if(d){let u=g(d.center,i.center);const m=h(u),b=m-r.distance;b!=0&&(b>0?u=l(u,1/m*b*(1-r.elasticity)*(d.static?1:.5)):u=l(u,1/m*b*r.rigidity*(d.static?1:.5)),N(i,u),i.velocity=B(i.velocity,l(u,t))),(i.static||d.static)&&(i.static||(i.velocity.x-=i.velocity.x*(1-e.damp)/t*e.jointRestriction,i.velocity.y-=i.velocity.y*(1-e.damp)/t*e.jointRestriction,i.angularVelocity-=i.angularVelocity*(1-e.angularDamp)/t*e.jointRestriction),d.static||(d.velocity.x-=d.velocity.x*(1-e.damp)/t*e.jointRestriction,d.velocity.y-=d.velocity.y*(1-e.damp)/t*e.jointRestriction,d.angularVelocity-=d.angularVelocity*(1-e.angularDamp)/t*e.jointRestriction))}}}for(let i=9;i--;){let f=!1;for(let r=n.length;r--;){const s=n[r];if(s.velocity)for(let d=o.length;d-- >r;){if(r===d)continue;const u=o[d];if(gt(s,u)){let m=F();if(Bt(e,s,u,m)){if(u.permeability>0){s.velocity.x*=1-u.permeability,s.velocity.y*=1-u.permeability,s.angularVelocity*=1-u.permeability;continue}C(m.normal,g(u.center,s.center))<0&&(m={depth:m.depth,normal:l(m.normal,-1),start:m.end,end:m.start}),pt(e,s,u,m)&&(f=!0,c.push({bodyAId:s.id,bodyBId:u.id,depth:m.depth}))}}}}if(!f)break}for(const i of n)i.restingTime+=1/t,Math.abs(i.center.x-i.averageCenter.x)>.1&&(i.averageCenter.x=i.center.x,i.restingTime=0),Math.abs(i.center.y-i.averageCenter.y)>.1&&(i.averageCenter.y=i.center.y,i.restingTime=0),Math.abs(i.angle-i.averageAngle)>=.05&&(i.averageAngle=i.angle,i.restingTime=0);return c}y.worldStep=lt;function dt(t,e=1,n){return!(n??t.dynamicBodies).find(o=>o.restingTime<e)}y.atRest=dt;function x(t,e){return{x:t,y:e}}y.newVec2=x;function h(t){return C(t,t)**.5}y.lengthVec2=h;function B(t,e){return x(t.x+e.x,t.y+e.y)}y.addVec2=B;function g(t,e){return B(t,l(e,-1))}y.subtractVec2=g;function l(t,e){return x(t.x*e,t.y*e)}y.scaleVec2=l;function C(t,e){return t.x*e.x+t.y*e.y}y.dotProduct=C;function A(t,e){return t.x*e.y-t.y*e.x}y.crossProduct=A;function k(t,e,n){const o=t.x-e.x,a=t.y-e.y;return x(o*Math.cos(n)-a*Math.sin(n)+e.x,o*Math.sin(n)+a*Math.cos(n)+e.y)}y.rotateVec2=k;function M(t){return l(t,1/(h(t)||1))}y.normalize=M;const F=()=>({depth:0,normal:x(0,0),start:x(0,0),end:x(0,0)});function E(t,e,n,o){e<t.depth||(t.depth=e,t.normal.x=n.x,t.normal.y=n.y,t.start.x=o.x,t.start.y=o.y,t.end=B(o,l(n,e)))}function yt(t,e){let n=0;for(const o of t){const a=o.type===v.RECTANGLE?(Math.hypot(o.width,o.height)/2,e>0?1/(e*(o.width**2+o.height**2)/12):0):e>0?e*o.bounds**2/12:0;n+=a/t.length}return n}function K(t,e){return t.x=Math.floor(t.x),t.y=Math.floor(t.y),e=Math.floor(e),{type:v.CIRCLE,center:t,bounds:e,boundingBox:J(v.CIRCLE,e,[],t)}}y.createCircleShape=K;function Q(t,e,n){t.x=Math.floor(t.x),t.y=Math.floor(t.y),e=Math.floor(e),n=Math.floor(n);const o=[x(t.x-e/2,t.y-n/2),x(t.x+e/2,t.y-n/2),x(t.x+e/2,t.y+n/2),x(t.x-e/2,t.y+n/2)],a=$(o),c=Math.hypot(e,n)/2;return{type:v.RECTANGLE,width:e,height:n,center:t,vertices:o,faceNormals:a,bounds:c,boundingBox:J(v.RECTANGLE,c,o,t)}}y.createRectangleShape=Q;function U(t,e,n,o,a,c,i){const f={id:t.nextId++,center:e,friction:o,restitution:a,shapes:c,static:!0,angle:0,permeability:0,data:i??null};return n?{...f,static:!1,averageCenter:x(e.x,e.y),mass:1/n,velocity:x(0,0),acceleration:t.gravity,averageAngle:0,angularVelocity:0,angularAcceleration:0,inertia:yt(c,n),restingTime:0,fixedPosition:!1,fixedRotation:!1}:f}function mt(t,e,n){e.static?t.staticBodies.push(e):(n??t.dynamicBodies).push(e)}y.addBody=mt;function xt(t,e,n){const o=e.static?t.staticBodies:n??t.dynamicBodies,a=o.findIndex(c=>c.id==e.id);a>=0&&o.splice(a,1)}y.removeBody=xt;function gt(t,e){for(const n of t.shapes)for(const o of e.shapes){const a=Math.abs(n.center.x-o.center.x)<n.boundingBox.x+o.boundingBox.x,c=Math.abs(n.center.y-o.center.y)<n.boundingBox.y+o.boundingBox.y;if(a&&c)return!0}return!1}function Z(t){t.boundingBox=J(t.type,t.bounds,t.type===v.RECTANGLE?t.vertices:[],t.center)}function J(t,e,n,o){if(t===v.CIRCLE)return{x:e,y:e};{let a=0,c=0;for(const i of n)a=Math.max(a,Math.abs(o.x-i.x)),c=Math.max(c,Math.abs(o.y-i.y));return{x:a,y:c}}}function vt(t){t.faceNormals=$(t.vertices)}function $(t){const e=[];for(let n=4;n--;)e[n]=M(g(t[(n+1)%4],t[(n+2)%4]));return e}function w(t,e,n){let o,a,c,i,f=1e9,r=-1,s=!0,d,u;for(a=4;s&&a--;){o=t.faceNormals[a];const m=l(o,-1),b=t.vertices[a];let R,p;for(u=-1e9,d=-1,c=4;c--;)R=g(e.vertices[c],b),p=C(R,m),p>0&&p>u&&(d=e.vertices[c],u=p);s=d!==-1,s&&u<f&&(f=u,r=a,i=d)}return s&&E(n,f,t.faceNormals[r],B(i,l(t.faceNormals[r],f))),s}function T(t,e){return e.static?!0:e.restingTime>t.restTime}function Bt(t,e,n,o){if(T(t,e)&&T(t,n))return!1;for(let a of e.shapes)for(let c of n.shapes){if(a.type==v.CIRCLE&&c.type===v.CIRCLE){const i=g(c.center,a.center),f=a.bounds+c.bounds,r=h(i);if(r<=Math.sqrt(f*f)){const s=M(l(i,-1)),d=l(s,c.bounds);E(o,f-r,M(i),B(c.center,d));continue}continue}if(a.type==v.RECTANGLE&&c.type==v.RECTANGLE){let i=!1,f=!1;const r=F();if(i=w(a,c,r),i){const s=F();if(f=w(c,a,s),f)if(r.depth<s.depth){E(o,r.depth,r.normal,g(r.start,l(r.normal,r.depth)));continue}else{E(o,s.depth,l(s.normal,-1),s.start);continue}}continue}if(a.type===v.CIRCLE&&c.type===v.RECTANGLE&&([a,c]=[c,a]),a.type===v.RECTANGLE&&c.type===v.CIRCLE){let i=1,f=-1e9,r=0,s,d,u,m;for(s=4;s--;){if(u=c.center,d=g(u,a.vertices[s]),m=C(d,a.faceNormals[s]),m>0){f=m,r=s,i=0;break}m>f&&(f=m,r=s)}let b,R;if(i&&u){E(o,c.bounds-f,a.faceNormals[r],g(u,l(a.faceNormals[r],c.bounds)));continue}else if(u){let p=g(u,a.vertices[r]),V=g(a.vertices[(r+1)%4],a.vertices[r]),L=C(p,V);if(L<0){if(b=h(p),b>c.bounds)continue;R=M(p),E(o,c.bounds-b,R,B(u,l(R,-c.bounds)));continue}else if(p=g(u,a.vertices[(r+1)%4]),V=l(V,-1),L=C(p,V),L<0){if(b=h(p),b>c.bounds)continue;R=M(p),E(o,c.bounds-b,R,B(u,l(R,-c.bounds)));continue}else if(f<c.bounds){E(o,c.bounds-f,a.faceNormals[r],g(u,l(a.faceNormals[r],c.bounds)));continue}else continue}continue}}return o.depth>0}function pt(t,e,n,o){if(T(t,e)&&T(t,n))return!1;const a=e.static?0:e.mass,c=n.static?0:n.mass,i=e.static?0:e.inertia,f=n.static?0:n.inertia,r=o.depth/(a+c)*.8,s=l(o.normal,r),d=o.normal;if(s.x===0&&s.y===0)return!1;e.static||N(e,l(s,-a)),n.static||N(n,l(s,c));const u=l(o.start,c/(a+c)),m=l(o.end,a/(a+c)),b=B(u,m),R=g(b,e.center),p=g(b,n.center),V=e.static?x(0,0):B(e.velocity,x(-1*e.angularVelocity*R.y,e.angularVelocity*R.x)),L=n.static?x(0,0):B(n.velocity,x(-1*n.angularVelocity*p.y,n.angularVelocity*p.x)),P=g(L,V),tt=C(P,d);if(tt>0)return!1;const et=Math.min(e.restitution,n.restitution),bt=Math.min(e.friction,n.friction),z=A(R,d),O=A(p,d),j=-(1+et)*tt/(a+c+z*z*i+O*O*f);let I=l(d,j);e.static||(e.fixedPosition||(e.velocity=g(e.velocity,l(I,e.mass))),e.fixedRotation||(e.angularVelocity-=z*j*e.inertia)),n.static||(n.fixedPosition||(n.velocity=B(n.velocity,l(I,n.mass))),n.fixedRotation||(n.angularVelocity+=O*j*n.inertia));const S=l(M(g(P,l(d,C(P,d)))),-1),q=A(R,S),X=A(p,S);let G=-(1+et)*C(P,S)*bt/(a+c+q*q*i+X*X*f);return G>j&&(G=j),I=l(S,G),e.static||(e.velocity=g(e.velocity,l(I,e.mass)),e.angularVelocity-=q*G*e.inertia,e.velocity.x*=t.damp,e.velocity.y*=t.damp,e.angularVelocity*=t.angularDamp),n.static||(n.velocity=B(n.velocity,l(I,n.mass)),n.angularVelocity+=X*G*n.inertia,n.velocity.x*=t.damp,n.velocity.y*=t.damp,n.angularVelocity*=t.angularDamp),!0}})(physics||(physics={}));
