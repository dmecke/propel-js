"use strict";export var physics;(function(y){let g;(function(e){e[e.CIRCLE=0]="CIRCLE",e[e.RECTANGLE=1]="RECTANGLE"})(g=y.ShapeType||(y.ShapeType={}));function D(e,t){return[...t??e.dynamicBodies,...e.staticBodies,...e.disabledBodies]}y.allBodies=D;function O(e,t){return[...t??e.dynamicBodies,...e.staticBodies]}y.enabledBodies=O;function Z(e,t,i){const a=(i??e.dynamicBodies).findIndex(o=>o.id===t.id);a!==-1&&(i??e.dynamicBodies).splice(a,1);const r=e.staticBodies.findIndex(o=>o.id===t.id);r!==-1&&e.staticBodies.splice(r,1),e.disabledBodies.includes(t)||e.disabledBodies.push(t)}y.disableBody=Z;function $(e,t,i){!t.static&&!(i??e.dynamicBodies).find(a=>a.id===t.id)&&(i??e.dynamicBodies).push(t),t.static&&!e.staticBodies.includes(t)&&e.staticBodies.push(t),e.disabledBodies.includes(t)&&e.disabledBodies.splice(e.disabledBodies.indexOf(t),1)}y.enableBody=$;function w(e,t=!1,i){const a=t?e.staticBodies:D(e,i);if(a.length===0)return{min:x(0,0),max:x(0,0)};const r=a[0];let o=x(r.center.x-r.bounds,r.center.y-r.bounds),n=x(r.center.x+r.bounds,r.center.y+r.bounds);for(const c of a)if(c.type===g.CIRCLE)o.x=Math.min(o.x,c.center.x-c.bounds),o.y=Math.min(o.y,c.center.y-c.bounds),n.x=Math.max(n.x,c.center.x+c.bounds),n.y=Math.max(n.y,c.center.y+c.bounds);else if(c.type===g.RECTANGLE)for(const l of c.vertices)o.x=Math.min(o.x,l.x),o.y=Math.min(o.y,l.y),n.x=Math.max(n.x,l.x),n.y=Math.max(n.y,l.y);return{min:o,max:n}}y.getWorldBounds=w;function tt(e,t=1){return{staticBodies:[],dynamicBodies:[],disabledBodies:[],gravity:e??x(0,100),angularDamp:.98,damp:.98,nextId:1,joints:[],frameCount:0,jointRestriction:1,restTime:t}}y.createWorld=tt;function et(e,t,i,a=1,r=0){e.joints.push({bodyA:t.id,bodyB:i.id,distance:M(v(t.center,i.center))+.5,rigidity:a,elasticity:r})}y.createJoint=et;function it(e,t,i,a,r,o,n){return t.x=Math.floor(t.x),t.y=Math.floor(t.y),i=Math.floor(i),X(e,t,a,r,o,0,i,void 0,void 0,n)}y.createCircle=it;function nt(e,t,i,a,r,o,n,c){return t.x=Math.floor(t.x),t.y=Math.floor(t.y),i=Math.floor(i),a=Math.floor(a),X(e,t,r,o,n,1,Math.hypot(i,a)/2,i,a,c)}y.createRectangle=nt;function at(e,t){N(e,t,!0)}y.moveBody=at;function N(e,t,i=!1){if(!(!i&&e.static)&&(e.center=C(e.center,t),e.type===g.RECTANGLE)){for(let a=4;a--;)e.vertices[a]=C(e.vertices[a],t);G(e)}}function rt(e,t){if(e.center=t,e.type===g.RECTANGLE){for(let i=4;i--;)e.vertices[i]=C(e.vertices[i],t);G(e)}}y.setCenter=rt;function ot(e,t){if(e.angle=t,e.averageAngle=t,e.type===g.RECTANGLE){for(let i=4;i--;)e.vertices[i]=S(e.vertices[i],e.center,t);_(e),G(e)}}y.setRotation=ot;function q(e,t){if(t&&(e.angle+=t,e.type)){for(let i=4;i--;)e.vertices[i]=S(e.vertices[i],e.center,t);_(e),G(e)}}y.rotateBody=q;function ct(e,t,i){i=i??t.dynamicBodies;const a=O(t,i),r=D(t,i),o=[];for(const n of i)!n.velocity&&!n.acceleration||T(t,n)||(n.velocity=C(n.velocity,d(n.acceleration,1/e)),N(n,d(n.velocity,1/e)),n.angularVelocity+=n.angularAcceleration*1/e,q(n,n.angularVelocity*1/e));for(const n of i){const c=t.joints.filter(l=>l.bodyA===n.id||l.bodyB===n.id);for(const l of c){const f=l.bodyA===n.id?l.bodyB:l.bodyA,u=r.find(s=>s.id===f);if(u){let s=v(u.center,n.center);const m=M(s),B=m-l.distance;B!=0&&(B>0?s=d(s,1/m*B*(1-l.elasticity)*(u.static?1:.5)):s=d(s,1/m*B*l.rigidity*(u.static?1:.5)),N(n,s),n.velocity=C(n.velocity,d(s,e))),(n.static||u.static)&&(n.static||(n.velocity.x-=n.velocity.x*(1-t.damp)/e*t.jointRestriction,n.velocity.y-=n.velocity.y*(1-t.damp)/e*t.jointRestriction,n.angularVelocity-=n.angularVelocity*(1-t.angularDamp)/e*t.jointRestriction),u.static||(u.velocity.x-=u.velocity.x*(1-t.damp)/e*t.jointRestriction,u.velocity.y-=u.velocity.y*(1-t.damp)/e*t.jointRestriction,u.angularVelocity-=u.angularVelocity*(1-t.angularDamp)/e*t.jointRestriction))}}}for(let n=9;n--;){let c=!1;for(let l=i.length;l--;){const f=i[l];if(f.velocity)for(let u=a.length;u-- >l;){if(l===u)continue;const s=a[u];if(dt(f,s)){let m=W();if(yt(t,f,s,m)){if(s.permeability>0){f.velocity.x*=1-s.permeability,f.velocity.y*=1-s.permeability,f.angularVelocity*=1-s.permeability;continue}E(m.normal,v(s.center,f.center))<0&&(m={depth:m.depth,normal:d(m.normal,-1),start:m.end,end:m.start}),mt(t,f,s,m)&&(c=!0,o.push({bodyAId:f.id,bodyBId:s.id,depth:m.depth}))}}}}if(!c)break}for(const n of i)n.restingTime+=1/e,Math.abs(n.center.x-n.averageCenter.x)>.1&&(n.averageCenter.x=n.center.x,n.restingTime=0),Math.abs(n.center.y-n.averageCenter.y)>.1&&(n.averageCenter.y=n.center.y,n.restingTime=0),Math.abs(n.angle-n.averageAngle)>=.05&&(n.averageAngle=n.angle,n.restingTime=0);return o}y.worldStep=ct;function ut(e,t=1,i){return!(i??e.dynamicBodies).find(a=>a.restingTime<t)}y.atRest=ut;function x(e,t){return{x:e,y:t}}y.newVec2=x;function M(e){return E(e,e)**.5}y.lengthVec2=M;function C(e,t){return x(e.x+t.x,e.y+t.y)}y.addVec2=C;function v(e,t){return C(e,d(t,-1))}y.subtractVec2=v;function d(e,t){return x(e.x*t,e.y*t)}y.scaleVec2=d;function E(e,t){return e.x*t.x+e.y*t.y}y.dotProduct=E;function A(e,t){return e.x*t.y-e.y*t.x}y.crossProduct=A;function S(e,t,i){const a=e.x-t.x,r=e.y-t.y;return x(a*Math.cos(i)-r*Math.sin(i)+t.x,a*Math.sin(i)+r*Math.cos(i)+t.y)}y.rotateVec2=S;function V(e){return d(e,1/(M(e)||1))}y.normalize=V;const W=()=>({depth:0,normal:x(0,0),start:x(0,0),end:x(0,0)});function b(e,t,i,a){e.depth=t,e.normal.x=i.x,e.normal.y=i.y,e.start.x=a.x,e.start.y=a.y,e.end=C(a,d(i,t))}function st(e,t,i,a,r){return e===g.RECTANGLE?(Math.hypot(a,r)/2,t>0?1/(t*(a**2+r**2)/12):0):t>0?t*i**2/12:0}function X(e,t,i,a,r,o,n,c=0,l=0,f){let u,s;o===g.RECTANGLE?(u=[x(t.x-c/2,t.y-l/2),x(t.x+c/2,t.y-l/2),x(t.x+c/2,t.y+l/2),x(t.x-c/2,t.y+l/2)],s=H(u)):(u=[],s=[]);const m={id:e.nextId++,type:o,center:t,friction:a,restitution:r,bounds:n,boundingBox:Y(o,n,u,t),width:c,height:l,faceNormals:s,vertices:u,static:!0,angle:0,permeability:0,data:f??null};return i?{...m,static:!1,averageCenter:x(t.x,t.y),mass:1/i,velocity:x(0,0),acceleration:e.gravity,averageAngle:0,angularVelocity:0,angularAcceleration:0,inertia:st(o,i,n,c,l),restingTime:0}:m}function lt(e,t,i){t.static?e.staticBodies.push(t):(i??e.dynamicBodies).push(t)}y.addBody=lt;function ft(e,t,i){const a=t.static?e.staticBodies:i??e.dynamicBodies,r=a.findIndex(o=>o.id==t.id);r>=0&&a.splice(r,1)}y.removeBody=ft;function dt(e,t){const i=Math.abs(e.center.x-t.center.x)<e.boundingBox.x+t.boundingBox.x,a=Math.abs(e.center.y-t.center.y)<e.boundingBox.y+t.boundingBox.y;return i&&a}function G(e){e.boundingBox=Y(e.type,e.bounds,e.vertices,e.center)}function Y(e,t,i,a){if(e===g.CIRCLE)return{x:t,y:t};{let r=0,o=0;for(const n of i)r=Math.max(r,Math.abs(a.x-n.x)),o=Math.max(o,Math.abs(a.y-n.y));return{x:r,y:o}}}function _(e){e.faceNormals=H(e.vertices)}function H(e){const t=[];for(let i=4;i--;)t[i]=V(v(e[(i+1)%4],e[(i+2)%4]));return t}function K(e,t,i){let a,r,o,n,c=1e9,l=-1,f=!0,u,s;for(r=4;f&&r--;){a=e.faceNormals[r];const m=d(a,-1),B=e.vertices[r];let p,R;for(s=-1e9,u=-1,o=4;o--;)p=v(t.vertices[o],B),R=E(p,m),R>0&&R>s&&(u=t.vertices[o],s=R);f=u!==-1,f&&s<c&&(c=s,l=r,n=u)}return f&&b(i,c,e.faceNormals[l],C(n,d(e.faceNormals[l],c))),f}function T(e,t){return t.static?!0:t.restingTime>e.restTime}function yt(e,t,i,a){if(T(e,t)&&T(e,i))return!1;if(t.type==g.CIRCLE&&i.type===g.CIRCLE){const r=v(i.center,t.center),o=t.bounds+i.bounds,n=M(r);if(n<=Math.sqrt(o*o)){const c=V(d(r,-1)),l=d(c,i.bounds);return b(a,o-n,V(r),C(i.center,l)),!0}return!1}if(t.type==g.RECTANGLE&&i.type==g.RECTANGLE){let r=!1,o=!1;const n=W();if(r=K(t,i,n),r){const c=W();if(o=K(i,t,c),o)return n.depth<c.depth?(b(a,n.depth,n.normal,v(n.start,d(n.normal,n.depth))),!0):(b(a,c.depth,d(c.normal,-1),c.start),!0)}return!1}if(t.type===g.CIRCLE&&i.type===g.RECTANGLE&&([t,i]=[i,t]),t.type===g.RECTANGLE&&i.type===g.CIRCLE){let r=1,o=-1e9,n=0,c,l,f,u;for(c=4;c--;){if(f=i.center,l=v(f,t.vertices[c]),u=E(l,t.faceNormals[c]),u>0){o=u,n=c,r=0;break}u>o&&(o=u,n=c)}let s,m;if(r&&f)return b(a,i.bounds-o,t.faceNormals[n],v(f,d(t.faceNormals[n],i.bounds))),!0;if(f){let B=v(f,t.vertices[n]),p=v(t.vertices[(n+1)%4],t.vertices[n]),R=E(B,p);return R<0?(s=M(B),s>i.bounds?!1:(m=V(B),b(a,i.bounds-s,m,C(f,d(m,-i.bounds))),!0)):(B=v(f,t.vertices[(n+1)%4]),p=d(p,-1),R=E(B,p),R<0?(s=M(B),s>i.bounds?!1:(m=V(B),b(a,i.bounds-s,m,C(f,d(m,-i.bounds))),!0)):o<i.bounds?(b(a,i.bounds-o,t.faceNormals[n],v(f,d(t.faceNormals[n],i.bounds))),!0):!1)}return!1}return!1}function mt(e,t,i,a){if(T(e,t)&&T(e,i))return!1;const r=t.static?0:t.mass,o=i.static?0:i.mass,n=t.static?0:t.inertia,c=i.static?0:i.inertia,l=a.depth/(r+o)*.8,f=d(a.normal,l),u=a.normal;if(f.x===0&&f.y===0)return!1;t.static||N(t,d(f,-r)),i.static||N(i,d(f,o));const s=d(a.start,o/(r+o)),m=d(a.end,r/(r+o)),B=C(s,m),p=v(B,t.center),R=v(B,i.center),xt=t.static?x(0,0):C(t.velocity,x(-1*t.angularVelocity*p.y,t.angularVelocity*p.x)),vt=i.static?x(0,0):C(i.velocity,x(-1*i.angularVelocity*R.y,i.angularVelocity*R.x)),P=v(vt,xt),Q=E(P,u);if(Q>0)return!1;const U=Math.min(t.restitution,i.restitution),Bt=Math.min(t.friction,i.friction),k=A(p,u),F=A(R,u),L=-(1+U)*Q/(r+o+k*k*n+F*F*c);let j=d(u,L);t.static||(t.velocity=v(t.velocity,d(j,t.mass)),t.angularVelocity-=k*L*t.inertia),i.static||(i.velocity=C(i.velocity,d(j,i.mass)),i.angularVelocity+=F*L*i.inertia);const h=d(V(v(P,d(u,E(P,u)))),-1),J=A(p,h),z=A(R,h);let I=-(1+U)*E(P,h)*Bt/(r+o+J*J*n+z*z*c);return I>L&&(I=L),j=d(h,I),t.static||(t.velocity=v(t.velocity,d(j,t.mass)),t.angularVelocity-=J*I*t.inertia,t.velocity.x*=e.damp,t.velocity.y*=e.damp,t.angularVelocity*=e.angularDamp),i.static||(i.velocity=C(i.velocity,d(j,i.mass)),i.angularVelocity+=z*I*i.inertia,i.velocity.x*=e.damp,i.velocity.y*=e.damp,i.angularVelocity*=e.angularDamp),!0}})(physics||(physics={}));
