"use strict";export var physics;(function(y){let g;(function(e){e[e.CIRCLE=0]="CIRCLE",e[e.RECTANGLE=1]="RECTANGLE"})(g=y.ShapeType||(y.ShapeType={}));function D(e,t){return[...t??e.dynamicBodies,...e.staticBodies,...e.disabledBodies]}y.allBodies=D;function O(e,t){return[...t??e.dynamicBodies,...e.staticBodies]}y.enabledBodies=O;function Z(e,t,i){const a=(i??e.dynamicBodies).findIndex(r=>r.id===t.id);a!==-1&&(i??e.dynamicBodies).splice(a,1);const o=e.staticBodies.findIndex(r=>r.id===t.id);o!==-1&&e.staticBodies.splice(o,1),e.disabledBodies.includes(t)||e.disabledBodies.push(t)}y.disableBody=Z;function $(e,t,i){!t.static&&!(i??e.dynamicBodies).find(a=>a.id===t.id)&&(i??e.dynamicBodies).push(t),t.static&&!e.staticBodies.includes(t)&&e.staticBodies.push(t),e.disabledBodies.includes(t)&&e.disabledBodies.splice(e.disabledBodies.indexOf(t),1)}y.enableBody=$;function w(e,t=!1,i){const a=t?e.staticBodies:D(e,i);if(a.length===0)return{min:x(0,0),max:x(0,0)};const o=a[0];let r=x(o.center.x-o.bounds,o.center.y-o.bounds),n=x(o.center.x+o.bounds,o.center.y+o.bounds);for(const c of a)if(c.type===g.CIRCLE)r.x=Math.min(r.x,c.center.x-c.bounds),r.y=Math.min(r.y,c.center.y-c.bounds),n.x=Math.max(n.x,c.center.x+c.bounds),n.y=Math.max(n.y,c.center.y+c.bounds);else if(c.type===g.RECTANGLE)for(const l of c.vertices)r.x=Math.min(r.x,l.x),r.y=Math.min(r.y,l.y),n.x=Math.max(n.x,l.x),n.y=Math.max(n.y,l.y);return{min:r,max:n}}y.getWorldBounds=w;function tt(e,t=1){return{staticBodies:[],dynamicBodies:[],disabledBodies:[],gravity:e??x(0,100),angularDamp:.98,damp:.98,nextId:1,joints:[],frameCount:0,jointRestriction:1,restTime:t}}y.createWorld=tt;function et(e,t,i,a=1,o=0){e.joints.push({bodyA:t.id,bodyB:i.id,distance:M(v(t.center,i.center))+.5,rigidity:a,elasticity:o})}y.createJoint=et;function it(e,t,i,a,o,r,n){return t.x=Math.floor(t.x),t.y=Math.floor(t.y),i=Math.floor(i),X(e,t,a,o,r,0,i,void 0,void 0,n)}y.createCircle=it;function nt(e,t,i,a,o,r,n,c){return t.x=Math.floor(t.x),t.y=Math.floor(t.y),i=Math.floor(i),a=Math.floor(a),X(e,t,o,r,n,1,Math.hypot(i,a)/2,i,a,c)}y.createRectangle=nt;function at(e,t){N(e,t,!0)}y.moveBody=at;function N(e,t,i=!1){if(!(!i&&e.static)&&(e.center=R(e.center,t),e.type===g.RECTANGLE)){for(let a=4;a--;)e.vertices[a]=R(e.vertices[a],t);P(e)}}function ot(e,t){if(e.center=t,e.type===g.RECTANGLE){for(let i=4;i--;)e.vertices[i]=R(e.vertices[i],t);P(e)}}y.setCenter=ot;function rt(e,t){if(e.angle=t,e.averageAngle=t,e.type===g.RECTANGLE){for(let i=4;i--;)e.vertices[i]=S(e.vertices[i],e.center,t);_(e),P(e)}}y.setRotation=rt;function q(e,t){if(t&&(e.angle+=t,e.type)){for(let i=4;i--;)e.vertices[i]=S(e.vertices[i],e.center,t);_(e),P(e)}}y.rotateBody=q;function ct(e,t,i){i=i??t.dynamicBodies;const a=O(t,i),o=D(t,i),r=[];for(const n of i)!n.velocity&&!n.acceleration||T(t,n)||(n.fixedPosition?(n.velocity.x=0,n.velocity.y=0):(n.velocity=R(n.velocity,d(n.acceleration,1/e)),N(n,d(n.velocity,1/e))),n.fixedRotation?(n.angularVelocity=0,n.angularAcceleration=0):(n.angularVelocity+=n.angularAcceleration*1/e,q(n,n.angularVelocity*1/e)));for(const n of i){const c=t.joints.filter(l=>l.bodyA===n.id||l.bodyB===n.id);for(const l of c){const s=l.bodyA===n.id?l.bodyB:l.bodyA,u=o.find(f=>f.id===s);if(u){let f=v(u.center,n.center);const m=M(f),B=m-l.distance;B!=0&&(B>0?f=d(f,1/m*B*(1-l.elasticity)*(u.static?1:.5)):f=d(f,1/m*B*l.rigidity*(u.static?1:.5)),N(n,f),n.velocity=R(n.velocity,d(f,e))),(n.static||u.static)&&(n.static||(n.velocity.x-=n.velocity.x*(1-t.damp)/e*t.jointRestriction,n.velocity.y-=n.velocity.y*(1-t.damp)/e*t.jointRestriction,n.angularVelocity-=n.angularVelocity*(1-t.angularDamp)/e*t.jointRestriction),u.static||(u.velocity.x-=u.velocity.x*(1-t.damp)/e*t.jointRestriction,u.velocity.y-=u.velocity.y*(1-t.damp)/e*t.jointRestriction,u.angularVelocity-=u.angularVelocity*(1-t.angularDamp)/e*t.jointRestriction))}}}for(let n=9;n--;){let c=!1;for(let l=i.length;l--;){const s=i[l];if(s.velocity)for(let u=a.length;u-- >l;){if(l===u)continue;const f=a[u];if(dt(s,f)){let m=W();if(yt(t,s,f,m)){if(f.permeability>0){s.velocity.x*=1-f.permeability,s.velocity.y*=1-f.permeability,s.angularVelocity*=1-f.permeability;continue}E(m.normal,v(f.center,s.center))<0&&(m={depth:m.depth,normal:d(m.normal,-1),start:m.end,end:m.start}),mt(t,s,f,m)&&(c=!0,r.push({bodyAId:s.id,bodyBId:f.id,depth:m.depth}))}}}}if(!c)break}for(const n of i)n.restingTime+=1/e,Math.abs(n.center.x-n.averageCenter.x)>.1&&(n.averageCenter.x=n.center.x,n.restingTime=0),Math.abs(n.center.y-n.averageCenter.y)>.1&&(n.averageCenter.y=n.center.y,n.restingTime=0),Math.abs(n.angle-n.averageAngle)>=.05&&(n.averageAngle=n.angle,n.restingTime=0);return r}y.worldStep=ct;function ut(e,t=1,i){return!(i??e.dynamicBodies).find(a=>a.restingTime<t)}y.atRest=ut;function x(e,t){return{x:e,y:t}}y.newVec2=x;function M(e){return E(e,e)**.5}y.lengthVec2=M;function R(e,t){return x(e.x+t.x,e.y+t.y)}y.addVec2=R;function v(e,t){return R(e,d(t,-1))}y.subtractVec2=v;function d(e,t){return x(e.x*t,e.y*t)}y.scaleVec2=d;function E(e,t){return e.x*t.x+e.y*t.y}y.dotProduct=E;function A(e,t){return e.x*t.y-e.y*t.x}y.crossProduct=A;function S(e,t,i){const a=e.x-t.x,o=e.y-t.y;return x(a*Math.cos(i)-o*Math.sin(i)+t.x,a*Math.sin(i)+o*Math.cos(i)+t.y)}y.rotateVec2=S;function V(e){return d(e,1/(M(e)||1))}y.normalize=V;const W=()=>({depth:0,normal:x(0,0),start:x(0,0),end:x(0,0)});function b(e,t,i,a){e.depth=t,e.normal.x=i.x,e.normal.y=i.y,e.start.x=a.x,e.start.y=a.y,e.end=R(a,d(i,t))}function ft(e,t,i,a,o){return e===g.RECTANGLE?(Math.hypot(a,o)/2,t>0?1/(t*(a**2+o**2)/12):0):t>0?t*i**2/12:0}function X(e,t,i,a,o,r,n,c=0,l=0,s){let u,f;r===g.RECTANGLE?(u=[x(t.x-c/2,t.y-l/2),x(t.x+c/2,t.y-l/2),x(t.x+c/2,t.y+l/2),x(t.x-c/2,t.y+l/2)],f=H(u)):(u=[],f=[]);const m={id:e.nextId++,type:r,center:t,friction:a,restitution:o,bounds:n,boundingBox:Y(r,n,u,t),width:c,height:l,faceNormals:f,vertices:u,static:!0,angle:0,permeability:0,data:s??null};return i?{...m,static:!1,averageCenter:x(t.x,t.y),mass:1/i,velocity:x(0,0),acceleration:e.gravity,averageAngle:0,angularVelocity:0,angularAcceleration:0,inertia:ft(r,i,n,c,l),restingTime:0,fixedPosition:!1,fixedRotation:!1}:m}function lt(e,t,i){t.static?e.staticBodies.push(t):(i??e.dynamicBodies).push(t)}y.addBody=lt;function st(e,t,i){const a=t.static?e.staticBodies:i??e.dynamicBodies,o=a.findIndex(r=>r.id==t.id);o>=0&&a.splice(o,1)}y.removeBody=st;function dt(e,t){const i=Math.abs(e.center.x-t.center.x)<e.boundingBox.x+t.boundingBox.x,a=Math.abs(e.center.y-t.center.y)<e.boundingBox.y+t.boundingBox.y;return i&&a}function P(e){e.boundingBox=Y(e.type,e.bounds,e.vertices,e.center)}function Y(e,t,i,a){if(e===g.CIRCLE)return{x:t,y:t};{let o=0,r=0;for(const n of i)o=Math.max(o,Math.abs(a.x-n.x)),r=Math.max(r,Math.abs(a.y-n.y));return{x:o,y:r}}}function _(e){e.faceNormals=H(e.vertices)}function H(e){const t=[];for(let i=4;i--;)t[i]=V(v(e[(i+1)%4],e[(i+2)%4]));return t}function K(e,t,i){let a,o,r,n,c=1e9,l=-1,s=!0,u,f;for(o=4;s&&o--;){a=e.faceNormals[o];const m=d(a,-1),B=e.vertices[o];let p,C;for(f=-1e9,u=-1,r=4;r--;)p=v(t.vertices[r],B),C=E(p,m),C>0&&C>f&&(u=t.vertices[r],f=C);s=u!==-1,s&&f<c&&(c=f,l=o,n=u)}return s&&b(i,c,e.faceNormals[l],R(n,d(e.faceNormals[l],c))),s}function T(e,t){return t.static?!0:t.restingTime>e.restTime}function yt(e,t,i,a){if(T(e,t)&&T(e,i))return!1;if(t.type==g.CIRCLE&&i.type===g.CIRCLE){const o=v(i.center,t.center),r=t.bounds+i.bounds,n=M(o);if(n<=Math.sqrt(r*r)){const c=V(d(o,-1)),l=d(c,i.bounds);return b(a,r-n,V(o),R(i.center,l)),!0}return!1}if(t.type==g.RECTANGLE&&i.type==g.RECTANGLE){let o=!1,r=!1;const n=W();if(o=K(t,i,n),o){const c=W();if(r=K(i,t,c),r)return n.depth<c.depth?(b(a,n.depth,n.normal,v(n.start,d(n.normal,n.depth))),!0):(b(a,c.depth,d(c.normal,-1),c.start),!0)}return!1}if(t.type===g.CIRCLE&&i.type===g.RECTANGLE&&([t,i]=[i,t]),t.type===g.RECTANGLE&&i.type===g.CIRCLE){let o=1,r=-1e9,n=0,c,l,s,u;for(c=4;c--;){if(s=i.center,l=v(s,t.vertices[c]),u=E(l,t.faceNormals[c]),u>0){r=u,n=c,o=0;break}u>r&&(r=u,n=c)}let f,m;if(o&&s)return b(a,i.bounds-r,t.faceNormals[n],v(s,d(t.faceNormals[n],i.bounds))),!0;if(s){let B=v(s,t.vertices[n]),p=v(t.vertices[(n+1)%4],t.vertices[n]),C=E(B,p);return C<0?(f=M(B),f>i.bounds?!1:(m=V(B),b(a,i.bounds-f,m,R(s,d(m,-i.bounds))),!0)):(B=v(s,t.vertices[(n+1)%4]),p=d(p,-1),C=E(B,p),C<0?(f=M(B),f>i.bounds?!1:(m=V(B),b(a,i.bounds-f,m,R(s,d(m,-i.bounds))),!0)):r<i.bounds?(b(a,i.bounds-r,t.faceNormals[n],v(s,d(t.faceNormals[n],i.bounds))),!0):!1)}return!1}return!1}function mt(e,t,i,a){if(T(e,t)&&T(e,i))return!1;const o=t.static?0:t.mass,r=i.static?0:i.mass,n=t.static?0:t.inertia,c=i.static?0:i.inertia,l=a.depth/(o+r)*.8,s=d(a.normal,l),u=a.normal;if(s.x===0&&s.y===0)return!1;t.static||N(t,d(s,-o)),i.static||N(i,d(s,r));const f=d(a.start,r/(o+r)),m=d(a.end,o/(o+r)),B=R(f,m),p=v(B,t.center),C=v(B,i.center),xt=t.static?x(0,0):R(t.velocity,x(-1*t.angularVelocity*p.y,t.angularVelocity*p.x)),vt=i.static?x(0,0):R(i.velocity,x(-1*i.angularVelocity*C.y,i.angularVelocity*C.x)),G=v(vt,xt),Q=E(G,u);if(Q>0)return!1;const U=Math.min(t.restitution,i.restitution),Bt=Math.min(t.friction,i.friction),k=A(p,u),F=A(C,u),L=-(1+U)*Q/(o+r+k*k*n+F*F*c);let j=d(u,L);t.static||(t.fixedPosition||(t.velocity=v(t.velocity,d(j,t.mass))),t.fixedRotation||(t.angularVelocity-=k*L*t.inertia)),i.static||(i.fixedPosition||(i.velocity=R(i.velocity,d(j,i.mass))),i.fixedRotation||(i.angularVelocity+=F*L*i.inertia));const h=d(V(v(G,d(u,E(G,u)))),-1),J=A(p,h),z=A(C,h);let I=-(1+U)*E(G,h)*Bt/(o+r+J*J*n+z*z*c);return I>L&&(I=L),j=d(h,I),t.static||(t.velocity=v(t.velocity,d(j,t.mass)),t.angularVelocity-=J*I*t.inertia,t.velocity.x*=e.damp,t.velocity.y*=e.damp,t.angularVelocity*=e.angularDamp),i.static||(i.velocity=R(i.velocity,d(j,i.mass)),i.angularVelocity+=z*I*i.inertia,i.velocity.x*=e.damp,i.velocity.y*=e.damp,i.angularVelocity*=e.angularDamp),!0}})(physics||(physics={}));
